name: ROS test workflow

on: [push]

jobs:
        test:
                runs-on: ubuntu-18.04
                steps:
                        - uses: actions/checkout@v2
                        - uses: actions/setup-python@v2
                        - name: echo command
                          run: echo "Hello World"
                        
                        - name: packages
                          run:
                              pip install --user catkin_pkg
                              pip install --user empy
                              pip install --user pyyaml
                              pip install --user rospkg

                              pip install --upgrade pip
                        
                        - name: ver check
                          run:
                                echo "$(lsb_release -sc)"
                        - name: ros install
                          run:
                                UBUNTU_VER=$(lsb_release -sc)
                                ROS_VER=melodic

                                [ "$UBUNTU_VER" = "bionic" ] || exit 1

                                sudo sh -c 'echo "deb http://packages.ros.org/ros/ubuntu $(lsb_release -sc) main" > /etc/apt/sources.list.d/ros-latest.list'
                                
                                set +vx
                                while ! sudo apt-get install -y curl 
                                do
                                        echo '***WAITING TO GET A LOCK FOR APT...***'
                                        sleep 1
                                        done
                                set -vx

                                curl -k https://raw.githubusercontent.com/ros/rosdistro/master/ros.key | sudo apt-key add -
                                
                                sudo apt-get update || echo ""

                                sudo apt-get install -y ros-${ROS_VER}-ros-base
 
                                ls /etc/ros/rosdep/sources.list.d/20-default.list && sudo rm -f /etc/ros/rosdep/sources.list.d/20-default.list

                                sudo apt-get install -y python-pip

                                sudo pip install wheel

                                sudo -H pip install rosdep
                                
                                sudo rosdep init                      
                        
                                rosdep update            
                                
                                sudo apt-get install -y python-rosinstall

                                sudo apt-get install -y build-essential

                                grep -F "source /opt/ros/$ROS_VER/setup.bash" ~/.bashrc ||
                                echo "souce /opt/ros/$ROS_VER/setup.bash" >> ~/.bashrc

                                grep -F "ROS_MASTER_URI" ~/.bashrc ||
                                echo "export ROS_MASTER_URI=http://localhost:11311" >> ~/.bashrc

                                grep -F "ROS_HOSTNAME" ~/.bashrc ||
                                echo "export ROS_HOSTNAME=localhost" >> ~/.bashrc

                                sudo chown -R -c $USER:$USER $HOME/.ros/

                                sudo chmod 777 $HOME/.ros/

                                set +xv

                                echo '***INSTRUCTION*****************'
                                echo '* do the following command    *'
                                echo '* $ source ~/.bashrc          *'
                                echo '* after that, try             *'
                                echo '* $ LANG=C roscore            *'
                                echo '*******************************'
                                
                                mkdir -p ~/catkin_ws/src

                                cd ~/catkin_ws/src
                                
                                source /opt/ros/melodic/setup.bash

                                catkin_init_workspace

                                cd ~/catkin_ws

                                catkin_make

                                ls -la

                                cd ~

                                ls -la

                                cd catkin_ws

                                ls -la
 
                        - name: setup bash
                          run:                                
                                sudo chown -R -c $USER:$USER $HOME/catkin_ws
                          
                                source ~/catkin_ws/devel/setup.bash

                                bash -xve ./test/travis_package_make.bash

                                ls -la

                                source ~/catkin_ws/devel/setup.bash
                                
                                bash -xve ./test/travis_prepare_dummy_files.bash

                                echo "rostest"

                                cd ../../../

                                ls -la

                                rostest pimouse_ros test.launch

